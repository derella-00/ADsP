# 연관분석

## 1. 연관규칙

### 가. 개념

- 연관성 분석은 흔히 `장바구니분석`(Market Basket Analysis) 또는 `서열분석(Sequence Analysis)`이라고 부른다.
    - 장바구니 분석: ‘장바구니에 무엇이 같이 들어 있는지에 대한 분석’
    - 서열분석: ‘A를 산 다음에 B를 산다.’
- 기업의 데이터베이스에서 상품의 구매, 서비스 등 일련의 거래 또는 사건들 간의 규칙을 발견하기 위해 적용

### 나. 연관규칙의 형태

- 조건과 반응의 형태(if-then)로 이루어져 있다.
    - (Item set A) → (Item set B)

      If A then B : 만일 A가 일어난다면 B가 일어난다.

</br>

### 다. 연관규칙의 측도

- 산업의 특성에 따라 지지도, 신뢰도, 향상도 값을 잘 보고 규칙을 선택해야 한다.
    
#### (1) 지지도(support)
    
- 전체 거래 중 항목 A와 항목 B를 동시에 포함하는 거래의 비율로 정의한다.
        
    $지지도 = P(A\cap B)=\frac{A와\ B가\ 동시에\ 포함된\ 거래 수}{전체\ 거래 수}= \frac{A\cap B}{전체}$

</br>
    
#### (2) 신뢰도(confidence)
    
- 항목 A를 포함한 거래 중에서 항목 A와 항목 B가 같이 포함될 확률. 연관성의 정도를 파악할 수 있다.
        
    $신뢰도 = \frac{P(A\cap B)}{P(A)}=\frac{A와\ B가\ 동시에\ 포함된\ 거래수}{A를\ 포함하는\ 거래수}=\frac{지지도}{P(A)}$
        
</br>

##### (3) 향상도(Lift)
    
- A가 구매되지 않았을 때 품목 B의 구매확률에 비해 A가 구매됐을 때 품목 B의 구매확률의 증가 비이다. 연관규칙 A → B는 품목 A와 품목 B의 구매가 서로 관련이 없는 경우에 향상도가 1이 된다.

    $향상도 = \frac{P(B|A)}{P(B)}=\frac{P(A\cap B)}{P(A)P(B)}=\frac{A와\ B가\ 동시에\ 포함된\ 거래수}{A를\ 포함하는\ 거래수\times B를\ 포함하는\ 거래수}=\frac{지지도}{P(B)}$

</br>

---
### 예시    

        
|항목| 거래수 |상대도수|확률|
|---|---|---|---|
|옥수수차|200|200+500+300+100 = 1100|1100/1450 = 76%|
| 둥글레차 | 100 | 100+500+200+100 = 900 | 900/1450 = 62% |
| 율무차 | 50 | 50+300+200+100 = 650 | 650/1450 = 45% |
| {옥수수차, 둥글레차} | 500 | 500 + 100 = 600 | 600/1450 = 41% |
| {옥수수차, 율무차} | 300 | 300 + 100 = 400 | 400/1450 = 28% |
| {둥글레차, 율무차} | 200 | 200 + 100 = 300 | 300/1450 = 21% |
| {옥수수차, 둥글레차, 율무차} | 100 | 100 | 100/1450 = 7% |
| 전체 거래수 | 1450 |  |  |

| 항목 | P(A) | P(B) | P$(A∩B)$ | 신뢰도 $P(A∩B)/P(A)$ | 향상도 $P(A∩B)/P(A)*P(B)$ |
| --- | --- | --- | --- | --- | --- |
| 옥수수차 → 둥글레차 | 76% | 62% | 41% | 55% | 88% |
| 둥글레차 → 옥수수차 | 62% | 76% | 41% | 67% | 88% |
| 율무차 → 둥글레차 | 45% | 62% | 21% | 46% | 75% |
| 둥글레차 → 율무차 | 62% | 45% | 21% | 33% | 75% |
| 옥수수차 → 율무차 | 76% | 45% | 28% | 36% | 81% |
| 율무차 → 옥수수차 | 45% | 76% | 28% | 62% | 81% |
| {둥글레차, 율무차} → 옥수수차 | 21% | 76% | 7% | 33% | 44% |
| {옥수수차, 율무차} → 둥글레차 | 28% | 62% | 7% | 25% | 40% |
| {옥수수차, 둥글레차} → 율무차 | 41% | 45% | 7% | 17% | 37% |
    

</br>

### 라. 연관규칙의 절차

- 최소 지지도보다 큰 집합만을 대상으로 높은 지지도를 갖는 품목 집합을 찾는 것
- 처음에는 5%로 잡고 규칙이 충분히 도출되는지를 보고 다양하게 조절하여 시도
- 처음부터 너무 낮은 최소 지지도를 선정하는 것은 많은 리소스가 소모되므로 적절하지 않다.
- 절차
    
    ① 최소 지지도 결정 → ② 품목 중 최소 지지도를 넘는 품목 분류 → ③ 2가지 품목 집합 생성 → ④ 반복적으로 수행해 빈발품목 집합을 찾음
    
</br>

### 마. 연관규칙의 장점과 단점

#### 장점
- 탐색적인 기법으로, 조건 반응으로 표현되는 연관성 분석의 결과를 쉽게 이해할 수 있다.

- 강력한 비목적성 분석기법, 분석 방향이나 목적이 특별히 없는 경우 목적변수가 없으므로 유용하게 활용

- 사용이 편리한 분석 데이터의 형태로 거래 내용에 대한 데이터를 변환 없이 그 자체로 이용할 수 있는 간단한 자료 구조를 갖는다.

- 분석을 위한 계산이 간단

#### 단점

- 품목수가 증가하면 분석에 필요한 계산이 기하급수적 증가

  - 이를 개선하기 위해 유사한 품목을 한 범주로 일반화한다.

  - 연관 규칙의 신뢰도 하한을 새롭게 정의해 실제 드물게 관찰되는 의미가 적은 연관규칙은 제외
  
- 너무 **세분화한 품목을** 갖고 연관성 규칙을 찾으면 **의미없는 분석**이 될 수도 있다.
  
  - 적절히 구분되는 큰 범주로 구분해 전체 분석에 포함시킨 후 그 결과 중에서 세부적으로 연관규칙을 찾는 작업을 수행할 수 있다.

- 거래량이 적은 품목은 당연히 포함된 거래수가 적을 것이고, 규칙 발견 시 제외하기가 쉽다

</br>

### 바. 순차패턴(Sequence Analysis)

- 동시에 구매될 가능성이 큰 상품군을 찾아내는 연관성분석에 시간이라는 개념을 포함시켜 순차적으로 구매 가능성이 큰 상품군을 찾아내는 것
- 연관성분석에서의 데이터 형태에서 각각의 고객으로부터 발생한 구매시점에 대한 정복 포함된다.

</br></br>


## 2. 기존 연관성분석의 이슈

- 대용량 데이터에 대한 연관성분석이 불가능
- 시간이 많이 걸리거나 기존 시스템에서 실행 시 시스템 다운되는 현상이 발생할 수 있다.

</br></br>

## 3. 최근 연관성분석 동향

> 거래내역에 포함되어 있는 모든 품목의 개수가 n개 일 때, 품목들의 전체집합(item set)에서 추출할 수 있는 품목 부분집합의 개수는 $2^n-1$(공집합 제외)개다.

</br>

### 가. Apriori 알고리즘

- 최소 지지도보다 큰 지지도 값을 갖는 품목의 집합을 `빈발항목집합(frequent item set)`이라고 한다. Apriori 알고리즘은 모든 품목집합에 대한 지지도를 전부 계산하는 것이 아니라, 최소 지지도 이상의 빈발항목집합을 찾은 후 그것들에 대해서만 연관규칙을 계산하는 것
  
- 1세대 알고리즘으로 구현과 이해하기가 쉽다는 장점이 있으나, 지지도가 낮은 후보 집합 생성 시 아이템의 개수가 많아지면 계산 복잡도가 증가한다는 문제점
  
- Apriori 알고리즘의 분석 순서
    1. 최소지지도 설정
    2. 개별 품목 중에서 최소 지지도를 넘는 모든 품목을 찾는다
    3. 앞에서 찾은 개별 품목만을 이용해 최소지지도를 넘는 2 가지 품목을 찾는다
    4. 앞에서 찾은 품목 집합을 결합하여 최소지지도를 넘는 3 가지 품목 집합을 찾는다
    5. 반복적으로 수행하여 최소지지도가 넘는 빈발품목 집합을 찾는다.

### 나. FP-Growth(Frequent Pattern) 알고리즘

- **후보 빈발항목집합을 생성하지 않고, FP-Tree를 만든 후** 분할정복 방식을 통해 Apriori 알고리즘 보다 더 빠르게 빈발항목집합을 추출할 수 있는 방법
- **Apriori 알고리즘의 약점을 보완하기 위해 고안**된 것, 데이터베이스를 스캔하는 횟수가 작고, 빠른 속도로 분석이 가능하다.

# 4. 연관성 분석 활용방안

- 장바구니 분석의 경우는 실시간 상품추천을 통한 교차판매에 응용
- 순차패턴 분석 A를 구매한 사람인데 B를 구매하지 않은 경우, B를 추천하는 교차판매 캠페인에 사용

# 5. 연관성 분석 예제

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%206%E1%84%8C%E1%85%A5%E1%86%AF%20%E1%84%8B%E1%85%A7%E1%86%AB%E1%84%80%E1%85%AA%E1%86%AB%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%20d2568a1a15c34fa99768df2111c81c8a/Untitled%203.jpeg)

![Untitled](5%E1%84%8C%E1%85%A1%E1%86%BC%206%E1%84%8C%E1%85%A5%E1%86%AF%20%E1%84%8B%E1%85%A7%E1%86%AB%E1%84%80%E1%85%AA%E1%86%AB%E1%84%87%E1%85%AE%E1%86%AB%E1%84%89%E1%85%A5%E1%86%A8%20d2568a1a15c34fa99768df2111c81c8a/Untitled%204.jpeg)